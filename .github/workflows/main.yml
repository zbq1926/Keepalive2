name: Refresh Demo
on:
  workflow_dispatch: {}                 # 手动触发
  schedule:
    - cron: "0 20 * * *"               # 每天 04:00 北京时间(UTC+8) ≙ 前一日 20:00 UTC
  push:
    paths:
      - ".github/workflows/main.yml"    # 此文件变动时触发
permissions:
  contents: write
jobs:
  refresh-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'latest'  # 使用最新版本
      - name: Build project with shadcn
        shell: bash
        run: |
          rm -rf temp-app
          npx --yes create-next-app@latest temp-app \
            --yes --ts --eslint --tailwind --app --src-dir --turbopack --import-alias "@/*"
          npx --yes shadcn@canary init \
            --cwd temp-app -t next -b slate --src-dir --css-variables -y
          npx --yes shadcn@canary add \
            --cwd temp-app --all -y -o
          shopt -s dotglob nullglob
          for item in * .*; do
            case "$item" in
              .|..|.git|temp-app) continue ;;
              *) rm -rf "$item" ;;
            esac
          done
          cp -a temp-app/. .
          rm -rf temp-app
      - name: Install & Build
        shell: bash
        run: |
          npm install
          npm run build || true
      - name: Commit & Force Push (Demo only)
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email ""
          TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          
          # 创建全新的孤立分支（没有历史记录）
          git checkout --orphan Demo
          
          # 删除所有 git 追踪的文件
          git rm -rf --cached . 2>/dev/null || true
          
          # 添加所有当前文件
          git add -A
          
          # 提交并强制推送
          git commit -m "$TIME"
          git push --force origin Demo
